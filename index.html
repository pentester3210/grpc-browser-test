<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>gRPC-Web File Transfer</title>
  <script src="file_pb.js"></script>
  <script src="file_grpc_web_pb.js"></script>
  <script src="https://unpkg.com/@grpc/grpc-js@1.11.0/browser/grpc.js"></script>
  <script src="https://unpkg.com/grpc-web@1.4.2/dist/grpc-web-client.js"></script>
  <script>
    const { UploadRequest, UploadResponse, DownloadRequest, DownloadResponse } = proto.file;
    const FileServiceClient = proto.file.FileServiceClient;

    // const proxyUrl = 'http://localhost:8080';  // Change to ngrok URL for remote
    const proxyUrl = 'https://mischievous-thalia-periodically.ngrok-free.dev';
    const client = new FileServiceClient(proxyUrl);

    function uploadFile() {
      const fileInput = document.getElementById('uploadFile');
      const file = fileInput.files[0];
      if (!file) return;

      const call = client.upload({}, (err, response) => {
        if (err) {
          console.error('Upload error:', err);
          return;
        }
        console.log('Upload response:', response.getMessage(), response.getSize());
      });

      const reader = file.stream().getReader();
      const chunkSize = 1024 * 1024;  // 1 MiB
      let offset = 0;

      function readChunk() {
        reader.read().then(({done, value}) => {
          if (done) {
            call.end();
            return;
          }

          // Send chunk
          const req = new UploadRequest();
          req.setFilename(file.name);
          req.setChunk(value);
          req.setOffset(offset);
          call.write(req);

          offset += value.length;
          readChunk();
        });
      }

      readChunk();
    }

    function downloadFile() {
      const filename = document.getElementById('downloadFilename').value;
      if (!filename) return;

      const req = new DownloadRequest();
      req.setFilename(filename);
      req.setOffset(0);  // Change for resume

      const call = client.download(req);

      let chunks = [];
      call.on('data', (response) => {
        chunks.push(response.getChunk());
      });

      call.on('end', () => {
        const blob = new Blob(chunks);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
      });

      call.on('error', (err) => console.error('Download error:', err));
    }
  </script>
</head>
<body>
  <h1>Upload File</h1>
  <input type="file" id="uploadFile">
  <button onclick="uploadFile()">Upload</button>

  <h1>Download File</h1>
  <input type="text" id="downloadFilename" placeholder="Enter filename">
  <button onclick="downloadFile()">Download</button>
</body>
</html>